# PokerKit Holdem - Database Migration Job
# Run this job after deploying new version to apply database migrations
#
# Usage:
#   kubectl apply -f migration-job.yaml
#   kubectl wait --for=condition=complete job/db-migration -n pokerkit-prod --timeout=300s
#   kubectl logs -n pokerkit-prod job/db-migration
#
# To re-run migration (delete and recreate):
#   kubectl delete job db-migration -n pokerkit-prod
#   kubectl apply -f migration-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration
  namespace: pokerkit-prod
  labels:
    app: pokerkit
    component: migration
spec:
  ttlSecondsAfterFinished: 3600  # Auto-cleanup after 1 hour
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: pokerkit
        component: migration
    spec:
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: migration
          image: ghcr.io/OWNER/REPO/backend:latest
          imagePullPolicy: Always
          command: ["alembic", "upgrade", "head"]
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          envFrom:
            - configMapRef:
                name: pokerkit-config
            - secretRef:
                name: pokerkit-secrets
          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "256Mi"
