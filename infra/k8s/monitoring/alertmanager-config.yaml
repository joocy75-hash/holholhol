# PokerKit Holdem - AlertManager Configuration
# This is a template - configure actual receivers before deployment
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-config
  namespace: monitoring  # Usually alertmanager is in monitoring namespace
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      # Global SMTP settings (if using email)
      smtp_smarthost: 'smtp.example.com:587'
      smtp_from: 'alertmanager@example.com'
      smtp_auth_username: 'alertmanager@example.com'
      smtp_auth_password: 'CHANGE_ME'

      # Slack API URL (if using Slack)
      slack_api_url: 'https://hooks.slack.com/services/CHANGE_ME'

      # PagerDuty routing key (if using PagerDuty)
      pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

    # Route tree
    route:
      receiver: 'default-receiver'
      group_by: ['alertname', 'severity', 'service']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h

      routes:
        # Critical alerts go to PagerDuty and Slack
        - match:
            severity: critical
          receiver: 'critical-alerts'
          continue: true

        # Warning alerts go to Slack only
        - match:
            severity: warning
          receiver: 'warning-alerts'

        # PokerKit specific routing
        - match:
            service: pokerkit
          receiver: 'pokerkit-team'

    # Receivers
    receivers:
      - name: 'default-receiver'
        slack_configs:
          - channel: '#alerts-default'
            send_resolved: true
            title: '{{ .Status | toUpper }}: {{ .CommonLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *Alert:* {{ .Labels.alertname }}
              *Severity:* {{ .Labels.severity }}
              *Description:* {{ .Annotations.description }}
              *Details:*
                {{ range .Labels.SortedPairs }} - {{ .Name }}: {{ .Value }}
                {{ end }}
              {{ end }}

      - name: 'critical-alerts'
        pagerduty_configs:
          - service_key: 'CHANGE_ME'
            severity: critical
            description: '{{ .CommonAnnotations.summary }}'
            details:
              firing: '{{ .Alerts.Firing | len }}'
              resolved: '{{ .Alerts.Resolved | len }}'
        slack_configs:
          - channel: '#alerts-critical'
            send_resolved: true
            color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
            title: 'üö® CRITICAL: {{ .CommonLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *Summary:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              {{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
              {{ end }}

      - name: 'warning-alerts'
        slack_configs:
          - channel: '#alerts-warning'
            send_resolved: true
            color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
            title: '‚ö†Ô∏è Warning: {{ .CommonLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *Summary:* {{ .Annotations.summary }}
              *Description:* {{ .Annotations.description }}
              {{ end }}

      - name: 'pokerkit-team'
        slack_configs:
          - channel: '#pokerkit-alerts'
            send_resolved: true
            username: 'PokerKit AlertManager'
            icon_emoji: ':poker:'
            title: '{{ .Status | toUpper }}: {{ .CommonLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *Alert:* {{ .Labels.alertname }}
              *Severity:* {{ .Labels.severity }}
              *Service:* {{ .Labels.service }}
              *Description:* {{ .Annotations.description }}
              {{ if .Annotations.runbook_url }}*Runbook:* <{{ .Annotations.runbook_url }}|View Runbook>{{ end }}
              {{ end }}

    # Inhibition rules
    inhibit_rules:
      # If critical alert fires, inhibit warning
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'service']

      # If pod is down, inhibit resource alerts for that pod
      - source_match:
          alertname: 'BackendPodDown'
        target_match_re:
          alertname: 'High(CPU|Memory)Usage'
        equal: ['namespace']
