# PokerKit Holdem - Prometheus Alert Rules
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: pokerkit-alerts
  namespace: pokerkit-prod
  labels:
    app: pokerkit
    prometheus: main
spec:
  groups:
    # =============================================================================
    # Application Health
    # =============================================================================
    - name: pokerkit.application
      interval: 30s
      rules:
        # Backend pod down
        - alert: BackendPodDown
          expr: kube_deployment_status_replicas_available{namespace="pokerkit-prod", deployment="backend"} < 1
          for: 2m
          labels:
            severity: critical
            service: pokerkit
          annotations:
            summary: "Backend pods are down"
            description: "No backend pods are available in pokerkit-prod namespace for more than 2 minutes."
            runbook_url: "https://wiki.example.com/runbooks/pokerkit/backend-down"

        # Frontend pod down
        - alert: FrontendPodDown
          expr: kube_deployment_status_replicas_available{namespace="pokerkit-prod", deployment="frontend"} < 1
          for: 2m
          labels:
            severity: critical
            service: pokerkit
          annotations:
            summary: "Frontend pods are down"
            description: "No frontend pods are available in pokerkit-prod namespace for more than 2 minutes."

        # High pod restart rate
        - alert: PodRestartingFrequently
          expr: increase(kube_pod_container_status_restarts_total{namespace="pokerkit-prod"}[15m]) > 3
          for: 5m
          labels:
            severity: warning
            service: pokerkit
          annotations:
            summary: "Pod restarting frequently"
            description: "Pod {{ $labels.pod }} has restarted {{ $value }} times in the last 15 minutes."

        # Deployment replica mismatch
        - alert: DeploymentReplicasMismatch
          expr: |
            kube_deployment_spec_replicas{namespace="pokerkit-prod"}
            != kube_deployment_status_replicas_available{namespace="pokerkit-prod"}
          for: 10m
          labels:
            severity: warning
            service: pokerkit
          annotations:
            summary: "Deployment replicas mismatch"
            description: "Deployment {{ $labels.deployment }} has {{ $value }} replicas available but spec wants more."

    # =============================================================================
    # Resource Usage
    # =============================================================================
    - name: pokerkit.resources
      interval: 30s
      rules:
        # High CPU usage
        - alert: HighCPUUsage
          expr: |
            (
              sum(rate(container_cpu_usage_seconds_total{namespace="pokerkit-prod", container!=""}[5m])) by (pod, container)
              / sum(kube_pod_container_resource_limits{namespace="pokerkit-prod", resource="cpu"}) by (pod, container)
            ) > 0.85
          for: 10m
          labels:
            severity: warning
            service: pokerkit
          annotations:
            summary: "High CPU usage detected"
            description: "Container {{ $labels.container }} in pod {{ $labels.pod }} is using {{ $value | humanizePercentage }} of its CPU limit."

        # High memory usage
        - alert: HighMemoryUsage
          expr: |
            (
              sum(container_memory_usage_bytes{namespace="pokerkit-prod", container!=""}) by (pod, container)
              / sum(kube_pod_container_resource_limits{namespace="pokerkit-prod", resource="memory"}) by (pod, container)
            ) > 0.85
          for: 10m
          labels:
            severity: warning
            service: pokerkit
          annotations:
            summary: "High memory usage detected"
            description: "Container {{ $labels.container }} in pod {{ $labels.pod }} is using {{ $value | humanizePercentage }} of its memory limit."

        # Memory approaching limit (critical)
        - alert: MemoryApproachingLimit
          expr: |
            (
              sum(container_memory_usage_bytes{namespace="pokerkit-prod", container!=""}) by (pod, container)
              / sum(kube_pod_container_resource_limits{namespace="pokerkit-prod", resource="memory"}) by (pod, container)
            ) > 0.95
          for: 5m
          labels:
            severity: critical
            service: pokerkit
          annotations:
            summary: "Memory critically high"
            description: "Container {{ $labels.container }} in pod {{ $labels.pod }} is using {{ $value | humanizePercentage }} of memory limit. OOM kill imminent."

    # =============================================================================
    # Database (PostgreSQL)
    # =============================================================================
    - name: pokerkit.database
      interval: 30s
      rules:
        # PostgreSQL down
        - alert: PostgreSQLDown
          expr: kube_statefulset_replicas{namespace="pokerkit-prod", statefulset="postgres"} - kube_statefulset_status_replicas_ready{namespace="pokerkit-prod", statefulset="postgres"} > 0
          for: 1m
          labels:
            severity: critical
            service: pokerkit
          annotations:
            summary: "PostgreSQL is down"
            description: "PostgreSQL StatefulSet has {{ $value }} unavailable replicas."

        # PostgreSQL storage almost full
        - alert: PostgreSQLStorageAlmostFull
          expr: |
            (
              kubelet_volume_stats_used_bytes{namespace="pokerkit-prod", persistentvolumeclaim=~"postgres-data.*"}
              / kubelet_volume_stats_capacity_bytes{namespace="pokerkit-prod", persistentvolumeclaim=~"postgres-data.*"}
            ) > 0.85
          for: 10m
          labels:
            severity: warning
            service: pokerkit
          annotations:
            summary: "PostgreSQL storage almost full"
            description: "PostgreSQL storage is {{ $value | humanizePercentage }} full."

    # =============================================================================
    # Redis
    # =============================================================================
    - name: pokerkit.redis
      interval: 30s
      rules:
        # Redis down
        - alert: RedisDown
          expr: kube_deployment_status_replicas_available{namespace="pokerkit-prod", deployment="redis"} < 1
          for: 1m
          labels:
            severity: critical
            service: pokerkit
          annotations:
            summary: "Redis is down"
            description: "No Redis pods are available in pokerkit-prod namespace."

    # =============================================================================
    # HTTP/API Metrics (if using prometheus-client in backend)
    # =============================================================================
    - name: pokerkit.http
      interval: 30s
      rules:
        # High error rate
        - alert: HighErrorRate
          expr: |
            (
              sum(rate(http_requests_total{namespace="pokerkit-prod", status=~"5.."}[5m]))
              / sum(rate(http_requests_total{namespace="pokerkit-prod"}[5m]))
            ) > 0.05
          for: 5m
          labels:
            severity: warning
            service: pokerkit
          annotations:
            summary: "High HTTP error rate"
            description: "More than 5% of HTTP requests are returning 5xx errors."

        # Critical error rate
        - alert: CriticalErrorRate
          expr: |
            (
              sum(rate(http_requests_total{namespace="pokerkit-prod", status=~"5.."}[5m]))
              / sum(rate(http_requests_total{namespace="pokerkit-prod"}[5m]))
            ) > 0.10
          for: 2m
          labels:
            severity: critical
            service: pokerkit
          annotations:
            summary: "Critical HTTP error rate"
            description: "More than 10% of HTTP requests are returning 5xx errors. Immediate investigation required."

        # High latency
        - alert: HighLatency
          expr: |
            histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{namespace="pokerkit-prod"}[5m])) by (le, endpoint))
            > 1.0
          for: 5m
          labels:
            severity: warning
            service: pokerkit
          annotations:
            summary: "High API latency"
            description: "95th percentile latency for endpoint {{ $labels.endpoint }} is {{ $value }}s."

    # =============================================================================
    # HPA/Scaling
    # =============================================================================
    - name: pokerkit.scaling
      interval: 60s
      rules:
        # HPA at max replicas
        - alert: HPAAtMaxReplicas
          expr: |
            kube_horizontalpodautoscaler_status_current_replicas{namespace="pokerkit-prod"}
            == kube_horizontalpodautoscaler_spec_max_replicas{namespace="pokerkit-prod"}
          for: 15m
          labels:
            severity: warning
            service: pokerkit
          annotations:
            summary: "HPA at maximum replicas"
            description: "HPA {{ $labels.horizontalpodautoscaler }} has been at maximum replicas for 15 minutes. Consider increasing max replicas."

        # HPA unable to scale
        - alert: HPAUnableToScale
          expr: |
            kube_horizontalpodautoscaler_status_condition{namespace="pokerkit-prod", condition="ScalingLimited", status="true"} == 1
          for: 10m
          labels:
            severity: warning
            service: pokerkit
          annotations:
            summary: "HPA unable to scale"
            description: "HPA {{ $labels.horizontalpodautoscaler }} is unable to scale due to resource constraints."
