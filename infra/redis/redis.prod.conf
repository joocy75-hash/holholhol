# Redis Production Configuration for Poker Backend
# Phase 4.1: Memory Policy Settings for 300-500 concurrent users
#
# Apply with: redis-server /path/to/redis.prod.conf
# Or in Docker: docker run -v ./redis.prod.conf:/usr/local/etc/redis/redis.conf redis redis-server /usr/local/etc/redis/redis.conf

# =============================================================================
# Memory Configuration
# =============================================================================

# Maximum memory limit (2GB for 16GB server)
maxmemory 2gb

# Eviction policy: Remove least recently used keys when memory limit is reached
# allkeys-lru: Evict any key based on LRU regardless of TTL
# This is ideal for game state cache where data can be reconstructed from DB
maxmemory-policy allkeys-lru

# LRU algorithm accuracy (higher = more accurate, more CPU)
# Default is 5, using 10 for better eviction accuracy
maxmemory-samples 10

# =============================================================================
# Connection Configuration
# =============================================================================

# Maximum client connections (support 500 users + overhead)
# 계산: 600 WS + 400 API pool + 50 Celery + 50 Pub/Sub + 여유분 = 1500
maxclients 1500

# TCP keepalive (seconds, 0 = disabled)
# 60초로 단축하여 죽은 연결 빠르게 감지
tcp-keepalive 60

# Connection timeout (300초 = 5분 유휴 연결 정리)
timeout 300

# TCP backlog
tcp-backlog 511

# =============================================================================
# Persistence Configuration
# =============================================================================

# RDB Snapshots (for recovery, not critical data)
# Save after 900 sec (15 min) if at least 1 key changed
save 900 1
# Save after 300 sec (5 min) if at least 10 keys changed
save 300 10
# Save after 60 sec if at least 10000 keys changed
save 60 10000

# Stop writes on RDB save errors
stop-writes-on-bgsave-error yes

# RDB compression
rdbcompression yes

# RDB checksum
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Working directory
dir ./

# AOF (Append Only File) - disabled for performance
# Game state can be reconstructed from PostgreSQL
appendonly no

# =============================================================================
# Pub/Sub Configuration
# =============================================================================

# Output buffer limits for pub/sub clients
# Normal clients
client-output-buffer-limit normal 0 0 0
# Replica clients
client-output-buffer-limit replica 256mb 64mb 60
# Pub/Sub clients (important for WebSocket broadcasting)
# 500명 동접 시 게임 브로드캐스트 버퍼 증가
client-output-buffer-limit pubsub 64mb 16mb 60

# =============================================================================
# Memory Optimization
# =============================================================================

# Hash encoding optimization (for small hashes)
# Use ziplist for hashes with <= 512 entries and max entry size 64 bytes
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List encoding optimization
list-max-ziplist-size -2
list-compress-depth 0

# Set encoding optimization
set-max-intset-entries 512

# Sorted set encoding optimization
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# =============================================================================
# Logging
# =============================================================================

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file (empty string = stdout)
logfile ""

# Syslog
syslog-enabled no

# =============================================================================
# Performance Tuning
# =============================================================================

# Lazyfree: Background deletion (reduces blocking)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Active defragmentation (experimental, use with caution)
activedefrag no

# I/O threads (for multi-core systems)
# io-threads 4
# io-threads-do-reads no

# =============================================================================
# Security (Production)
# =============================================================================

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command DEBUG ""

# Protected mode (enabled when no password and not bound)
protected-mode yes

# Require password (set via REDIS_PASSWORD env var or uncomment below)
# requirepass your_secure_password_here

# =============================================================================
# Slow Log
# =============================================================================

# Log queries slower than 10000 microseconds (10ms)
slowlog-log-slower-than 10000

# Keep 128 slow queries
slowlog-max-len 128
