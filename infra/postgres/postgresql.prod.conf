# PostgreSQL Production Configuration
# Phase 3.3: 300-500명 동시 접속 최적화
#
# 권장 서버 사양:
# - CPU: 4-8 cores
# - RAM: 16GB
# - SSD: 100GB+
#
# 적용 방법:
# 1. postgresql.conf에 다음 라인 추가:
#    include = 'conf.d/postgresql.prod.conf'
# 2. 또는 이 파일의 설정을 postgresql.conf에 직접 추가
# 3. PostgreSQL 재시작: sudo systemctl restart postgresql

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

# Maximum simultaneous connections
# 계산: (앱 서버당 커넥션 풀 크기) * (앱 서버 수) + 여유분
# 예: (50+30) * 4 + 30 = 350 (앱서버 4대 기준, 500명 동접)
max_connections = 350

# Superuser reserved connections (관리용)
superuser_reserved_connections = 3

#------------------------------------------------------------------------------
# MEMORY
#------------------------------------------------------------------------------

# Shared buffer pool (RAM의 25% 권장)
# 16GB RAM 기준: 4GB
shared_buffers = 4GB

# Effective cache size (RAM의 50-75% 권장)
# OS 파일 시스템 캐시 포함한 총 사용 가능 메모리 추정치
# PostgreSQL이 쿼리 플래닝에 사용
effective_cache_size = 12GB

# Work memory per operation
# 정렬, 해시 등 작업당 메모리
# 계산: (total_RAM - shared_buffers) / (max_connections * 2)
# 예: (16GB - 4GB) / (150 * 2) ≈ 40MB, 안전하게 32MB
work_mem = 32MB

# Maintenance work memory
# VACUUM, CREATE INDEX 등 유지보수 작업용
# 일반적으로 1GB면 충분
maintenance_work_mem = 1GB

# Huge pages (Linux only, optional)
# huge_pages = try

#------------------------------------------------------------------------------
# WRITE AHEAD LOG (WAL)
#------------------------------------------------------------------------------

# WAL level for replication support
wal_level = replica

# WAL buffer size
# 기본 16MB에서 64MB로 증가 (대용량 트랜잭션 지원)
wal_buffers = 64MB

# Checkpoint completion target
# 체크포인트가 checkpoint_timeout 동안 90% 완료되도록 분산
checkpoint_completion_target = 0.9

# Checkpoint timeout
# 체크포인트 간격 (기본 5분, 10분으로 증가)
checkpoint_timeout = 10min

# Maximum WAL size between checkpoints
max_wal_size = 4GB
min_wal_size = 1GB

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

# Random page cost (SSD 사용 시 낮춤)
# HDD: 4.0 (기본값), SSD: 1.1-1.5
random_page_cost = 1.1

# Effective I/O concurrency (SSD 사용 시 높임)
# HDD: 2 (기본값), SSD: 200
effective_io_concurrency = 200

# Default statistics target
# 더 정확한 쿼리 계획을 위해 증가 (기본 100)
default_statistics_target = 100

#------------------------------------------------------------------------------
# PARALLEL QUERY
#------------------------------------------------------------------------------

# Maximum parallel workers per gather
max_parallel_workers_per_gather = 4

# Maximum parallel maintenance workers (VACUUM, CREATE INDEX)
max_parallel_maintenance_workers = 2

# Maximum parallel workers
max_parallel_workers = 8

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------

# Log slow queries (100ms 이상)
log_min_duration_statement = 100

# Log format for analysis
log_line_prefix = '%t [%p]: user=%u,db=%d,app=%a,client=%h '

# Log checkpoints
log_checkpoints = on

# Log lock waits
log_lock_waits = on

# Log temp file usage
log_temp_files = 0

#------------------------------------------------------------------------------
# AUTOVACUUM
#------------------------------------------------------------------------------

# Autovacuum enabled
autovacuum = on

# Autovacuum workers
autovacuum_max_workers = 4

# Naptime between runs
autovacuum_naptime = 30s

# Scale factor for triggering (기본 20% -> 10%)
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

# Vacuum cost settings
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 1000

#------------------------------------------------------------------------------
# CONNECTION TIMEOUT
#------------------------------------------------------------------------------

# Statement timeout (0 = disabled)
# 앱에서 쿼리 타임아웃 관리 권장
statement_timeout = 0

# Idle in transaction timeout (5분)
# 트랜잭션 열어둔 채로 방치된 연결 정리
idle_in_transaction_session_timeout = 5min

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

# Timezone
timezone = 'Asia/Seoul'

# Default text search configuration
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# LOCK MANAGEMENT
#------------------------------------------------------------------------------

# Deadlock detection interval
deadlock_timeout = 1s

# Maximum locks per transaction
max_locks_per_transaction = 128

#------------------------------------------------------------------------------
# REPLICATION (for future HA setup)
#------------------------------------------------------------------------------

# Maximum WAL senders (for streaming replication)
max_wal_senders = 3

# Maximum replication slots
max_replication_slots = 3

# Hot standby
hot_standby = on
